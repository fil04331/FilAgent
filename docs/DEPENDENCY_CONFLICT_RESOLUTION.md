# Dependency Conflict Resolution - Summary

**Issue**: #[issue_number] - Python Dependency Conflict  
**Date**: December 8, 2025  
**Status**: ✅ RESOLVED

## Problem Statement

The GitHub Actions workflow was failing with the following error:

```
ERROR: Cannot install -r requirements.txt (line 21), -r requirements.txt (line 50) 
and dill==0.4.0 because these package versions have conflicting dependencies.
```

### Root Cause Analysis

1. **Duplicate Dependency Specifications**: The `dill` package appeared multiple times in `requirements.txt`:
   - Line 21: `dill==0.4.0` (transitive dependency from `datasets==4.4.1`)
   - Line 50: `multiprocess==0.70.18` (which requires `dill>=0.4.0`)
   
2. **Stale Generated Files**: The `requirements*.txt` files were marked as `@generated by PDM` but were not being regenerated after dependency changes in `pyproject.toml` and `pdm.lock`.

3. **Inconsistent Tooling**: While the repository uses PDM as the authoritative dependency manager, CI workflows were using pip directly with potentially outdated requirements files.

## Solution Implemented

### 1. Regenerated All Requirements Files ✅

Used PDM to export fresh requirements files from the locked dependencies:

```bash
pdm export --prod -o requirements.txt --without-hashes
pdm export --prod -G dev -o requirements-dev.txt --without-hashes
pdm export --prod -G ml -o requirements-ml.txt --without-hashes
pdm export --prod -G dev -G ml -G ui -G benchmark -o requirements_complete.txt --without-hashes
```

**Result**: All files now have exactly one `dill==0.4.0` entry, eliminating the conflict.

### 2. Updated Documentation ✅

- **README_SETUP.md**: Added PDM as the recommended installation method with fallback to pip
- **docs/DEPENDENCY_MANAGEMENT.md**: Enhanced with clear instructions on regenerating requirements files
- Added troubleshooting section for dependency conflicts

### 3. Created Automation Tools ✅

**Makefile**: Added convenient targets for dependency management:
```bash
make export-requirements  # Regenerate all requirements*.txt files
make install             # Install production dependencies
make install-dev         # Install all dependencies
make update              # Update dependencies and regenerate files
```

**.gitattributes**: Marked requirements files as generated to reduce diff noise:
```
requirements.txt linguist-generated=true
requirements-dev.txt linguist-generated=true
requirements-ml.txt linguist-generated=true
requirements_complete.txt linguist-generated=true
```

### 4. Updated All CI/CD Workflows ✅

Migrated from pip to PDM in all GitHub Actions workflows:

- ✅ `.github/workflows/codeql.yml`
- ✅ `.github/workflows/codeql-security.yml`
- ✅ `.github/workflows/codeql-advanced.yml`
- ✅ `.github/workflows/benchmarks.yml`
- ✅ `.github/workflows/deploy.yml`
- ✅ `.github/workflows/dependencies.yml`

**Standard pattern applied**:
```yaml
- name: Set up PDM
  uses: pdm-project/setup-pdm@v4
  with:
    python-version: '3.12'
    cache: true

- name: Install dependencies
  run: pdm install --prod --no-lock
```

## Validation

### Local Testing ✅

Created clean virtual environment and tested installation:
```bash
python -m venv /tmp/test_env
/tmp/test_env/bin/pip install -r requirements.txt
```

**Result**: Successfully installed 130+ packages with no conflicts.

### PDM Lock Validation ✅

```bash
pdm lock --check
```

**Result**: Lock file is valid and synchronized with `pyproject.toml`.

## Prevention Measures

### For Developers

1. **NEVER manually edit requirements*.txt files** - They are auto-generated
2. **ALWAYS use PDM commands** to manage dependencies:
   ```bash
   pdm add <package>        # Add dependency
   pdm remove <package>     # Remove dependency
   pdm update              # Update all dependencies
   make export-requirements # Regenerate requirements files
   ```
3. **ALWAYS commit both files** when changing dependencies:
   - `pyproject.toml` (source of truth)
   - `pdm.lock` (locked versions)
   - `requirements*.txt` (generated files)

### For CI/CD

The `dependencies.yml` workflow now includes an automatic job that:
- Validates lock file integrity on every push
- Checks for dependency conflicts
- Auto-regenerates requirements files on main branch
- Runs security scans weekly

## Single Source of Truth Architecture

```
pyproject.toml (AUTHORITATIVE)
    ↓
pdm lock (generates)
    ↓
pdm.lock (LOCKED VERSIONS)
    ↓
pdm export (generates)
    ↓
requirements*.txt (GENERATED, DO NOT EDIT)
    ↓
pip install (consumption by legacy tools)
```

## Key Takeaways

1. **PDM is the single source of truth** for dependency management in FilAgent
2. **Requirements files are generated artifacts** that must never be manually edited
3. **Consistent tooling across dev and CI** prevents environment drift
4. **Automated regeneration** ensures files stay synchronized
5. **Documentation** provides clear guidance to prevent future issues

## References

- [PDM Documentation](https://pdm-project.org/)
- [docs/DEPENDENCY_MANAGEMENT.md](./DEPENDENCY_MANAGEMENT.md)
- [Makefile](../Makefile) - Automation targets
- [.gitattributes](../.gitattributes) - File generation markers

---

**Resolution Confirmed**: ✅ All workflows now use PDM, dependency conflict eliminated, documentation updated.

**Next Steps**: Monitor CI runs to confirm workflows execute successfully with new PDM-based installation.
