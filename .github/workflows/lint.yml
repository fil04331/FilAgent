# GitHub Actions Workflow - Code Quality & Linting
#
# Ce workflow v√©rifie la qualit√© du code √† chaque push et PR
# - Black: Formatage PEP 8
# - isort: Tri des imports
# - flake8: Linting et d√©tection d'erreurs
# - mypy: V√©rification des types
# - Bandit: Analyse de s√©curit√©
#
# Documentation: https://docs.github.com/en/actions

name: Code Quality & Linting

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
      - 'feature/**'
      - 'fix/**'
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/workflows/lint.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/workflows/lint.yml'

# Annule les runs pr√©c√©dents sur la m√™me branche
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================
  # Job 1: Code Formatting Check
  # ============================
  formatting:
    name: Check Code Formatting (Black + isort)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black==24.1.0 isort==5.13.2

      - name: Check Black formatting
        run: |
          echo "üé® V√©rification du formatage avec Black..."
          black --check --diff --color .
        continue-on-error: false

      - name: Check import sorting (isort)
        run: |
          echo "üì¶ V√©rification du tri des imports avec isort..."
          isort --check-only --diff --color .
        continue-on-error: false

      - name: Format check summary
        if: failure()
        run: |
          echo "‚ùå Le code n'est pas format√© correctement."
          echo "üí° Pour corriger automatiquement, ex√©cutez :"
          echo "   black ."
          echo "   isort ."
          exit 1

  # ============================
  # Job 2: Linting avec flake8
  # ============================
  linting:
    name: Lint with flake8
    runs-on: ubuntu-latest
    needs: formatting  # Attend que le formatage soit OK

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8==7.0.0 flake8-docstrings flake8-bugbear

      - name: Lint critical errors (E9, F63, F7, F82)
        run: |
          echo "üîç D√©tection des erreurs critiques..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics
        continue-on-error: false

      - name: Lint code style (full check)
        run: |
          echo "üîç V√©rification compl√®te du style de code..."
          flake8 . \
            --count \
            --max-complexity=10 \
            --max-line-length=100 \
            --extend-ignore=E203,W503,W504 \
            --statistics \
            --exclude=.git,__pycache__,build,dist,.eggs,*.egg-info,.venv,venv,models/weights,.hypothesis
        continue-on-error: false

  # ============================
  # Job 3: Type Checking avec mypy
  # ============================
  type-checking:
    name: Type Checking with mypy
    runs-on: ubuntu-latest
    needs: formatting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-PyYAML types-requests pydantic

      - name: Run mypy
        run: |
          echo "üîç V√©rification des types avec mypy..."
          mypy runtime memory planner tools policy \
            --ignore-missing-imports \
            --show-error-codes \
            --pretty || true
        continue-on-error: true  # Warnings, pas bloquer pour l'instant

  # ============================
  # Job 4: Security Scan avec Bandit
  # ============================
  security:
    name: Security Scan (Bandit)
    runs-on: ubuntu-latest
    needs: formatting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          echo "üîí Analyse de s√©curit√© avec Bandit..."
          bandit -r runtime memory planner tools policy \
            -ll \
            -f json \
            -o bandit-report.json || true
        continue-on-error: true

      - name: Display Bandit results
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            echo "üìä R√©sum√© Bandit :"
            cat bandit-report.json | python -m json.tool | head -50
          fi

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  # ============================
  # Job 5: Test Import Structure
  # ============================
  import-test:
    name: Test Import Structure
    runs-on: ubuntu-latest
    needs: linting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pydantic

      - name: Test imports
        run: |
          echo "üì¶ Test des imports Python..."
          python -c "import runtime; print('‚úÖ runtime OK')" || exit 1
          python -c "import planner; print('‚úÖ planner OK')" || exit 1
          python -c "import memory; print('‚úÖ memory OK')" || exit 1
          python -c "import tools; print('‚úÖ tools OK')" || exit 1
          python -c "import policy; print('‚úÖ policy OK')" || exit 1
          echo "‚úÖ Tous les imports sont fonctionnels !"

  # ============================
  # Job 6: Summary
  # ============================
  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [formatting, linting, type-checking, security, import-test]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "üìä R√©sum√© du Quality Gate :"
          echo ""
          echo "‚úÖ Formatage (Black + isort) : ${{ needs.formatting.result }}"
          echo "‚úÖ Linting (flake8) : ${{ needs.linting.result }}"
          echo "‚ö†Ô∏è  Type checking (mypy) : ${{ needs.type-checking.result }}"
          echo "‚ö†Ô∏è  S√©curit√© (Bandit) : ${{ needs.security.result }}"
          echo "‚úÖ Test imports : ${{ needs.import-test.result }}"
          echo ""

          if [[ "${{ needs.formatting.result }}" == "success" ]] && \
             [[ "${{ needs.linting.result }}" == "success" ]] && \
             [[ "${{ needs.import-test.result }}" == "success" ]]; then
            echo "‚úÖ Quality Gate PASSED!"
            exit 0
          else
            echo "‚ùå Quality Gate FAILED!"
            echo "üí° Consultez les logs des jobs ci-dessus pour plus de d√©tails."
            exit 1
          fi
