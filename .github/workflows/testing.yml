# Nom du workflow (de l'agent de test)
name: Python Tests

# Déclencheurs : l'agent se lancera sur pull requests et pushes vers main
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
permissions:
  contents: read

jobs:
  test:
    # Le type de machine sur lequel l'agent va tourner
    runs-on: ubuntu-latest

    steps:
      # Étape 1: Récupère le code de votre dépôt
      - uses: actions/checkout@v5

      # Étape 2: Configure l'environnement Python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      # Étape 3: Installe et configure PDM
      - name: Set up PDM
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.12'
          cache: true

      # Étape 4: Cache des dépendances PDM
      - name: Cache PDM packages
        uses: actions/cache@v4
        with:
          path: |
            __pypackages__
            .pdm-build
          key: ${{ runner.os }}-pdm-${{ hashFiles('pdm.lock') }}
          restore-keys: |
            ${{ runner.os }}-pdm-

      # Étape 5: Installe les dépendances avec PDM
      - name: Install dependencies
        run: |
          pdm install --prod --no-lock
          pdm install --dev --no-lock

      # Étape 6: Exécute les tests avec pytest via PDM
      - name: Test with pytest
        run: |
          pdm run pytest
