name: DÃ©ploiement FilAgent
permissions:
  contents: read

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  validate:
    name: Validation prÃ©-dÃ©ploiement
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Validate configuration
        run: |
          echo "ðŸ“‹ Validation des configurations..."
          for file in config/*.yaml; do
            python -c "import yaml; yaml.safe_load(open('$file'))"
            echo "âœ… $file valide"
          done

      - name: Check compliance requirements
        run: |
          echo "ðŸ”’ VÃ©rification conformitÃ©..."
          required_files=(
            "runtime/middleware/worm.py"
            "runtime/middleware/audittrail.py"
            "runtime/middleware/redaction.py"
            "runtime/middleware/rbac.py"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Fichier critique manquant: $file"
              exit 1
            fi
          done
          echo "âœ… Tous les modules de conformitÃ© prÃ©sents"

  package:
    name: Package Application
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@v6

      - name: Create deployment package
        run: |
          # CrÃ©er package de dÃ©ploiement
          mkdir -p dist/filagent

          # Copier code
          cp -r runtime tools memory config dist/filagent/
          cp requirements.txt dist/filagent/

          # CrÃ©er script de dÃ©marrage
          cat > dist/filagent/start.sh << 'EOF'
          #!/bin/bash
          # Install PDM if not available
          if ! command -v pdm &> /dev/null; then
            python -m pip install pdm
          fi
          
          # Install dependencies using PDM
          pdm install --prod
          
          # Initialize database
          pdm run python -c "from memory.episodic import create_tables; create_tables()"
          
          # Start server
          pdm run python runtime/server.py
          EOF

          chmod +x dist/filagent/start.sh

          # CrÃ©er archive
          tar -czf filagent-deployment.tar.gz -C dist filagent

      - name: Upload package
        uses: actions/upload-artifact@v5
        with:
          name: deployment-package
          path: filagent-deployment.tar.gz

  deploy-staging:
    name: DÃ©ployer en Staging
    runs-on: ubuntu-latest
    needs: package
    if: github.event.inputs.environment == 'staging' || github.event_name == 'release'
    environment:
      name: staging

    steps:
      - name: Download package
        uses: actions/download-artifact@v6
        with:
          name: deployment-package

      - name: Deploy to staging
        run: |
          echo "ðŸš€ DÃ©ploiement en staging..."
          # Ici: ajoutez vos commandes de dÃ©ploiement rÃ©elles
          # Par exemple: scp, rsync, kubectl, docker push, etc.
          echo "âœ… DÃ©ployÃ© en staging"
